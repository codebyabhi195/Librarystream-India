<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyStream India | Pro Virtual Library</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

    <style>
        /* --- PREMIUM THEME VARIABLES --- */
        :root { 
            --ss-primary: #4f46e5; /* Modern Indigo */
            --ss-primary-light: #e0e7ff; 
            --ss-bg: #f8fafc; 
            --ss-surface: #ffffff;
            --ss-text: #0f172a; 
            --ss-text-light: #64748b;
            --ss-border: #e2e8f0; 
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 40px -5px rgba(0, 0, 0, 0.08);
            --radius-lg: 20px;
            --radius-xl: 28px;
        }

        body.dark-mode {
            --ss-bg: #0b0f19; 
            --ss-surface: #111827; 
            --ss-text: #f8fafc; 
            --ss-text-light: #94a3b8;
            --ss-border: #1e293b; 
            --ss-primary-light: #1e1b4b;
            --shadow-lg: 0 20px 40px -5px rgba(0, 0, 0, 0.4);
            background: var(--ss-bg);
        }

        /* --- GLOBAL RESETS & TYPOGRAPHY --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--ss-bg); color: var(--ss-text); 
            display: flex; height: 100vh; overflow: hidden; 
            -webkit-font-smoothing: antialiased;
        }

        /* Custom Beautiful Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- DESKTOP SIDEBAR --- */
        .sidebar { 
            width: 88px; height: 100vh; background: var(--ss-surface); 
            border-right: 1px solid var(--ss-border); 
            display: flex; flex-direction: column; align-items: center; 
            padding: 24px 0; position: fixed; left: 0; z-index: 100; 
            box-shadow: var(--shadow-sm); overflow-y: auto; overflow-x: hidden;
            transition: 0.3s ease;
        }
        .nav-item { 
            width: 52px; height: 52px; margin-bottom: 12px; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; border-radius: 16px; color: var(--ss-text-light); 
            font-size: 22px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            flex-shrink: 0; background: transparent;
        }
        .nav-item.active { 
            background: var(--ss-primary); color: #ffffff; 
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3); 
            transform: scale(1.05);
        }
        .nav-item:hover:not(.active) { 
            background: var(--ss-primary-light); color: var(--ss-primary); 
            transform: translateY(-2px); 
        }

        /* --- MAIN LAYOUT --- */
        .main-wrapper { 
            margin-left: 88px; flex: 1; display: flex; flex-direction: column; 
            width: calc(100% - 88px); animation: fadeIn 0.6s ease-out;
        }
        .top-nav { 
            height: 76px; display: flex; align-items: center; padding: 0 32px; 
            justify-content: space-between; background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            z-index: 90; border-bottom: 1px solid var(--ss-border);
            position: sticky; top: 0;
        }
        body.dark-mode .top-nav { background: rgba(17, 24, 39, 0.8); }
        
        .content-grid { 
            display: grid; grid-template-columns: 1fr 420px; 
            height: calc(100vh - 76px); overflow: hidden; 
        }
        .scroll-area { padding: 32px; overflow-y: auto; scroll-behavior: smooth; }
        .right-panel { 
            border-left: 1px solid var(--ss-border); padding: 32px; 
            overflow-y: auto; background: var(--ss-surface); 
        }

        /* --- PREMIUM UI COMPONENTS --- */
        .glass-card { 
            background: var(--ss-surface); border: 1px solid var(--ss-border); 
            border-radius: var(--radius-lg); padding: 24px; margin-bottom: 24px; 
            box-shadow: var(--shadow-sm); transition: all 0.3s ease; 
        }
        .glass-card:hover { 
            transform: translateY(-4px); box-shadow: var(--shadow-lg); 
            border-color: rgba(79, 70, 229, 0.2);
        }
        
        .room-card { 
            background: linear-gradient(145deg, var(--ss-surface), var(--ss-primary-light)); 
            border-radius: var(--radius-xl); padding: 32px; margin-bottom: 32px; 
            border: 1px solid var(--ss-border); box-shadow: var(--shadow-md); 
        }
        #video-container { 
            height: 480px; background: #000; border-radius: var(--radius-lg); 
            margin-bottom: 24px; overflow: hidden; display: flex; align-items: center; 
            justify-content: center; border: 2px dashed rgba(79, 70, 229, 0.3); 
            transition: 0.3s; position: relative;
        }
        
        .btn-ss { 
            background: var(--ss-primary); color: white; border: none; 
            padding: 12px 24px; border-radius: 12px; font-weight: 700; 
            font-family: 'Plus Jakarta Sans', sans-serif; cursor: pointer; 
            transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25); 
            letter-spacing: 0.5px;
        }
        .btn-ss:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(79, 70, 229, 0.35); }
        .btn-ss:active { transform: translateY(0); }

        /* Modern Inputs */
        input[type="text"], input[type="date"], input[type="number"], select, textarea {
            background: var(--ss-bg); border: 1px solid var(--ss-border); 
            border-radius: 12px; padding: 12px 18px; font-family: 'Plus Jakarta Sans', sans-serif; 
            outline: none; transition: 0.3s; color: var(--ss-text); width: 100%; font-size: 14px;
        }
        input:focus, textarea:focus, select:focus { 
            border-color: var(--ss-primary); box-shadow: 0 0 0 4px var(--ss-primary-light); 
            background: var(--ss-surface);
        }

        /* Floating Action Buttons (FABs) */
        .fab-container { position: fixed; bottom: 32px; right: 32px; display: flex; flex-direction: column; gap: 16px; z-index: 2000; }
        .fab-btn { 
            width: 56px; height: 56px; border-radius: 28px; border: none; 
            display: flex; align-items: center; justify-content: center; font-size: 24px; 
            cursor: pointer; box-shadow: var(--shadow-lg); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .fab-btn:hover { transform: scale(1.1) rotate(5deg); }
        .fab-ai { background: linear-gradient(135deg, #6366f1, #a855f7); color: white; }
        .fab-draw { background: var(--ss-surface); color: var(--ss-primary); border: 2px solid var(--ss-primary); }

        /* Modals (Smooth popups) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(6px);
            z-index: 2999; display: none; opacity: 0; transition: opacity 0.3s ease;
        }
        .premium-modal {
            display: none; position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(0.95); opacity: 0;
            background: var(--ss-surface); border-radius: var(--radius-xl); 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); z-index: 3000; 
            border: 1px solid var(--ss-border); transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .premium-modal.show { display: flex; transform: translate(-50%, -50%) scale(1); opacity: 1; flex-direction: column; }

        /* --- MOBILE RESPONSIVE (iOS App Feel) --- */
        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main-wrapper { margin-left: 0; width: 100%; }
            .content-grid { grid-template-columns: 1fr; display: block; overflow-y: auto; padding-bottom: 100px; }
            .scroll-area, .right-panel { padding: 16px; border: none; height: auto; }
            .top-nav { padding: 0 16px; height: 64px; }
            .top-nav input { width: 160px !important; font-size: 13px !important; }
            #video-container { height: 320px; border-radius: 16px; } 
            .room-card { padding: 20px; border-radius: 20px; }
            
            /* Floating Floating Glass Bottom Nav */
            .bottom-nav { 
                display: flex; position: fixed; bottom: 16px; left: 16px; width: calc(100% - 32px); 
                background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
                box-shadow: 0 8px 32px rgba(0,0,0,0.1); height: 72px; justify-content: space-around; 
                align-items: center; z-index: 1000; border-radius: 24px; border: 1px solid rgba(255,255,255,0.4);
            }
            body.dark-mode .bottom-nav { background: rgba(17, 24, 39, 0.85); border-color: rgba(255,255,255,0.05); }
            
            .b-nav-item { 
                font-size: 22px; color: var(--ss-text-light); cursor: pointer; 
                width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
                border-radius: 16px; transition: 0.3s ease; 
            }
            .b-nav-item.active { color: var(--ss-primary); background: var(--ss-primary-light); transform: translateY(-4px); }
            
            /* FAB adjustments for Mobile */
            .fab-container { bottom: 100px; right: 16px; }
            .fab-btn { width: 48px; height: 48px; font-size: 20px; }
        }
        @media (min-width: 901px) { .bottom-nav { display: none; } }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

        .online-indicator {
            display: inline-block; width: 8px; height: 8px; background: #10b981; 
            border-radius: 50%; margin-right: 6px; animation: pulse-green 2s infinite;
        }

        /* Flashcard 3D CSS */
        .fc-container { perspective: 1000px; width: 100%; height: 220px; margin-top: 16px; cursor: pointer; }
        .fc-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1); transform-style: preserve-3d; }
        .fc-container.flipped .fc-inner { transform: rotateY(180deg); }
        .fc-front, .fc-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 24px; border-radius: 20px; box-shadow: var(--shadow-sm); border: 2px solid var(--ss-primary-light); font-size: 18px; font-weight: 700; }
        .fc-front { background-color: var(--ss-surface); color: var(--ss-primary); }
        .fc-back { background-color: var(--ss-primary); color: white; transform: rotateY(180deg); font-size: 15px; font-weight: 500;}
    </style>
</head>
<body onload="initDashboard()">

    <div id="modalOverlay" class="modal-overlay" onclick="closeAllModals()"></div>

    <nav class="sidebar">
        <div style="margin-bottom: 24px; text-align: center; cursor: pointer; transition: 0.3s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" onclick="document.getElementById('fileInput').click()" title="Change Photo">
            <img id="myProfilePic" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 3px solid var(--ss-primary); padding: 2px; background:white;">
            <input type="file" id="fileInput" hidden accept="image/*" onchange="uploadPic()">
        </div>
        
        <div class="nav-item active" title="Home" onclick="document.getElementById('homeSection').scrollIntoView({behavior:'smooth'})">üè†</div>
        <div style="width: 32px; height: 2px; background: var(--ss-border); margin: 12px 0; border-radius: 2px;"></div>
        
        <div class="nav-item" title="üéß Ambient Mixer" onclick="openModal('soundMixerModal')" style="color: #ef4444; background: rgba(239, 68, 68, 0.1);">üéß</div>
        <div class="nav-item" title="üìÖ Daily Vocab" onclick="openDailyVocab()" style="color: #3b82f6; background: rgba(59, 130, 246, 0.1);">üìÖ</div>
        <div id="strictModeBtn" class="nav-item" title="‚ö° Strict Pomodoro (Off)" onclick="toggleStrictMode()" style="color: #64748b; background: rgba(100, 116, 139, 0.1);">‚ö°</div>
        <div class="nav-item" title="üé§ AI Mock Interview" onclick="openModal('interviewModal')" style="color: #c026d3; background: rgba(192, 38, 211, 0.1);">üé§</div>
        <div class="nav-item" title="üí∞ Doubt Bounty" onclick="openModal('bountyModal')" style="color: #ca8a04; background: rgba(202, 138, 4, 0.1);">üí∞</div>
        <div class="nav-item" title="üìà Consistency Graph" onclick="openModal('graphModal')" style="color: #10b981; background: rgba(16, 185, 129, 0.1);">üìà</div>
        <div class="nav-item" title="üÉè Flashcards" onclick="openModal('flashcardModal')" style="color: #3b82f6; background: rgba(59, 130, 246, 0.1);">üÉè</div>
        
        <div style="width: 32px; height: 2px; background: var(--ss-border); margin: 12px 0; border-radius: 2px;"></div>
        <div class="nav-item" title="Settings" onclick="location.href='settings.html'" style="background: var(--ss-bg);">‚öôÔ∏è</div>
    </nav>

    <div class="main-wrapper">
        <header class="top-nav">
            <div style="display:flex; align-items:center; gap:24px;">
                <span onclick="document.getElementById('homeSection').scrollIntoView({behavior:'smooth'})" style="font-weight:800; color:var(--ss-text); cursor:pointer; font-size:20px; letter-spacing: -0.5px;">StudyStream<span style="color:var(--ss-primary);">IN</span></span>
               <div style="position: relative;">
                   <input type="text" id="globalSearch" placeholder="Search tasks or Ask AI (Enter)..." 
                    onkeyup="handleSmartSearch(event)" 
                    style="width:340px; padding-left: 40px; border-radius: 20px; background: var(--ss-bg);">
                    <span style="position:absolute; left:14px; top:12px; opacity:0.5;">üîç</span>
               </div>
            </div>
            <div style="display:flex; align-items:center; gap: 20px;">
                <div style="font-size:13px; color:#10b981; font-weight:700; background:rgba(16, 185, 129, 0.1); padding:8px 16px; border-radius:20px; display:flex; align-items:center;">
                    <span class="online-indicator"></span> <span id="onlineCount">0</span> Online
                </div>
                <div onclick="toggleDarkMode()" style="cursor: pointer; font-size: 20px; background:var(--ss-bg); width: 42px; height: 42px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">üåô</div>
                <div style="position: relative; cursor: pointer; background:var(--ss-bg); width: 42px; height: 42px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                    <span style="font-size: 20px;">üîî</span>
                    <div id="notifDot" style="display:none; position: absolute; top: 0; right: 0; width: 12px; height: 12px; background: #ef4444; border-radius: 50%; border:2px solid var(--ss-surface);"></div>
                </div>
            </div>
        </header>

        <div class="content-grid">
            <main class="scroll-area" id="homeSection">
                <div style="margin-bottom:32px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                        <span style="font-size:13px; font-weight:800; color:var(--ss-text-light); letter-spacing:1.5px;">LEVEL PROGRESS</span>
                        <span style="font-size:13px; font-weight:800; color:var(--ss-primary);">‚≠ê Study Points</span>
                    </div>
                    <div style="height:10px; background:var(--ss-border); border-radius:5px; width:100%; overflow:hidden;">
                        <div id="progressFill" style="height:100%; background:linear-gradient(90deg, var(--ss-primary), #818cf8); width:0%; transition:1s cubic-bezier(0.4, 0, 0.2, 1); border-radius:5px; position:relative;">
                            <div style="position:absolute; top:0; left:0; right:0; bottom:0; background:linear-gradient(90deg,transparent,rgba(255,255,255,0.4),transparent); animation: shimmer 2s infinite;"></div>
                        </div>
                    </div>
                </div>

                <div class="room-card">
                    <h3 style="text-align:center; margin:0 0 24px 0; font-size:24px; color:var(--ss-text); font-weight:800;">üî¥ Live Study Groups</h3>
                    <div id="video-container">
                        <div style="text-align:center; color:rgba(255,255,255,0.7); display:flex; flex-direction:column; align-items:center;">
                            <div style="font-size: 64px; margin-bottom: 16px; animation: bounce 2s infinite; text-shadow: 0 10px 20px rgba(0,0,0,0.5);">üëá</div>
                            <h2 style="font-weight:700; letter-spacing:1px;">Select a Group to Join</h2>
                            <p style="font-size:14px; opacity:0.8;">Your camera is currently off.</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 16px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 24px; justify-content: center; scrollbar-width: none;">
                        <button onclick="joinRoom('Physics_Doubt')" class="btn-ss" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">‚öõÔ∏è Physics</button>
                        <button onclick="joinRoom('Maths_Solver')" class="btn-ss" style="background: linear-gradient(135deg, #f59e0b, #d97706);">‚ûó Maths</button>
                        <button onclick="joinRoom('Chill_Zone')" class="btn-ss" style="background: linear-gradient(135deg, #10b981, #059669);">‚òï Chill</button>
                        <button onclick="joinRoom('General_Study')" class="btn-ss" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">üåç General</button>
                    </div>
                    <div style="display: flex; gap: 12px; border-top: 1px solid var(--ss-border); padding-top: 24px; justify-content: center;">
                        <input type="text" id="customRoomInput" placeholder="Enter Secret Code..." style="width: 250px; background:var(--ss-surface);">
                        <button onclick="joinCustom()" class="btn-ss" style="background: #ef4444;">Join Private</button>
                    </div>
                </div>

                <div class="glass-card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="margin:0; font-size:18px; font-weight:700; display:flex; align-items:center; gap:8px;">üìù <span>Smart Notes</span></h3>
                        <div style="display:flex; gap:12px; align-items:center;">
                            <span id="saveStatus" style="font-size:12px; color:#10b981; display:none; font-weight:700; background:rgba(16,185,129,0.1); padding:4px 10px; border-radius:12px;">‚úì Auto-Saved</span>
                            <button onclick="downloadPDF()" style="background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.2); color:#ef4444; padding:8px 16px; border-radius:10px; cursor:pointer; font-size:13px; font-weight:700; transition:0.2s;" onmouseover="this.style.background='rgba(239,68,68,0.2)'" onmouseout="this.style.background='rgba(239,68,68,0.1)'">‚¨áÔ∏è Export PDF</button>
                        </div>
                    </div>
                    <textarea id="studyNotes" style="width:100%; height:200px; border:1px solid var(--ss-border); background:var(--ss-bg); border-radius:16px; padding:20px; font-size:15px; line-height:1.6; resize:none;" placeholder="Type your important concepts, code snippets, or formulas here..."></textarea>
                </div>
            </main>

            <aside class="right-panel" id="widgetSection">
                
                <div class="glass-card" style="background: linear-gradient(135deg, #FF512F 0%, #DD2476 100%); color: white; text-align: center; border:none; box-shadow: 0 15px 30px rgba(221, 36, 118, 0.2);">
                    <div id="examSetup" style="display: none;">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight:800;">üéØ Set Your Target Goal</h3>
                        <input type="text" id="targetName" placeholder="e.g. TCS Interview" style="width: 100%; margin-bottom: 12px; border:none; background:rgba(255,255,255,0.9); color:#000;">
                        <input type="date" id="targetDate" style="width: 100%; margin-bottom: 20px; border:none; background:rgba(255,255,255,0.9); color:#000;">
                        <button onclick="saveExamDate()" class="btn-ss" style="background: white; color: #DD2476; width:100%; font-size:16px;">Start Countdown üöÄ</button>
                    </div>
                    <div id="examDisplay" style="display: none; position:relative;">
                        <div style="font-size: 12px; font-weight:700; opacity: 0.9; letter-spacing:2px; margin-bottom:8px;">TIME LEFT FOR</div>
                        <div id="displayExamName" style="font-size:22px; font-weight:800; margin-bottom:20px; text-shadow:0 2px 4px rgba(0,0,0,0.2);">EXAM</div>
                        <div style="display: flex; justify-content: center; gap: 24px; align-items: baseline;">
                            <div style="background:rgba(255,255,255,0.25); backdrop-filter:blur(5px); padding:12px 20px; border-radius:16px; box-shadow:0 4px 15px rgba(0,0,0,0.1);"><span id="daysLeft" style="font-size: 36px; font-weight: 800;">00</span><div style="font-size: 11px; font-weight:700; letter-spacing:1px;">DAYS</div></div>
                            <div style="background:rgba(255,255,255,0.25); backdrop-filter:blur(5px); padding:12px 20px; border-radius:16px; box-shadow:0 4px 15px rgba(0,0,0,0.1);"><span id="hoursLeft" style="font-size: 28px; font-weight: 800;">00</span><div style="font-size: 11px; font-weight:700; letter-spacing:1px;">HRS</div></div>
                        </div>
                        <button onclick="editExam()" style="position: absolute; top: -10px; right: -10px; background: rgba(0,0,0,0.3); border: none; color: white; width:30px; height:30px; border-radius:50%; cursor: pointer; font-size: 14px; transition:0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.5)'" onmouseout="this.style.background='rgba(0,0,0,0.3)'">‚úé</button>
                    </div>
                </div>

                <div class="glass-card" style="text-align: center; position:relative; overflow:hidden;">
                    <div style="position:absolute; top:0; left:0; width:100%; height:4px; background:var(--ss-primary);"></div>
                    <h3 style="font-size: 14px; color: var(--ss-text-light); margin: 10px 0 20px 0; font-weight:800; letter-spacing:1.5px;">‚è±Ô∏è POMODORO TIMER</h3>
                    <div id="timerDisplay" style="font-size: 48px; font-weight: 800; color:var(--ss-text); font-variant-numeric: tabular-nums; letter-spacing:-1px;">25:00</div>
                    <p id="timerStatus" style="font-size: 14px; color: #10b981; font-weight:700; margin: 5px 0 20px 0; background:rgba(16,185,129,0.1); display:inline-block; padding:4px 12px; border-radius:12px;">Ready to Focus</p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button onclick="startPomodoro()" class="btn-ss" style="flex:1;">Focus</button>
                        <button onclick="startBreak()" class="btn-ss" style="background:var(--ss-bg); color:var(--ss-text); border:1px solid var(--ss-border); flex:1; box-shadow:none;">Break</button>
                        <button onclick="resetTimer()" class="btn-ss" style="background:none; border:2px solid var(--ss-border); color:var(--ss-text-light); padding:12px; box-shadow:none;">‚Ü∫</button>
                    </div>
                </div>

                <div class="glass-card" style="display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; border:none; padding:20px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 24px; background:rgba(255,255,255,0.1); width:48px; height:48px; display:flex; align-items:center; justify-content:center; border-radius:14px;">üéß</div>
                        <div><h3 style="font-size: 15px; font-weight:700; margin: 0;">Lofi Beats</h3><p style="font-size: 12px; margin: 4px 0 0 0; opacity: 0.7;">Deep Work Mode</p></div>
                    </div>
                    <div style="display: flex; gap: 12px; align-items:center;">
                        <button onclick="toggleMusic()" id="playBtn" style="background: white; border: none; color: #0f172a; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size:14px; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.3); transition:0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">‚ñ∂</button>
                        <input type="range" min="0" max="100" value="50" oninput="setVolume(this.value)" style="width: 60px; height:4px; padding:0; accent-color: var(--ss-primary); background:rgba(255,255,255,0.2); border:none;">
                    </div>
                    <div id="youtube-player" style="position: absolute; top: -9999px;"></div>
                </div>

                <div class="glass-card" id="taskSection">
                    <h3 style="font-size:14px; color:var(--ss-text-light); margin-bottom:20px; font-weight:800; letter-spacing:1px;">‚úÖ DAILY TASKS</h3>
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <input type="text" id="taskInput" placeholder="What to study today?" style="flex:1;">
                        <button onclick="addTask()" class="btn-ss" style="padding:12px 18px; font-size:18px;">+</button>
                    </div>
                    <div id="taskList" style="display:flex; flex-direction:column; gap:10px;"></div>
                </div>

                <div class="glass-card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="font-size:14px; color:var(--ss-text-light); margin:0; font-weight:800; letter-spacing:1px;">üèÜ TOPPERS</h3>
                        <select id="stateFilter" onchange="loadLB()" style="font-size:12px; padding:6px 12px; width:auto;">
                            <option value="All">All India</option><option value="UP">UP</option><option value="BR">Bihar</option><option value="MH">MH</option><option value="DL">Delhi</option>
                        </select>
                    </div>
                    <div id="leaderboard" style="display:flex; flex-direction:column; gap:10px;"></div>
                </div>

            </aside>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="b-nav-item active" onclick="document.getElementById('homeSection').scrollIntoView({behavior:'smooth'})">üè†</div>
        <div class="b-nav-item" onclick="openModal('soundMixerModal')">üéß</div>
        <div class="b-nav-item" onclick="document.getElementById('taskSection').scrollIntoView({behavior:'smooth'})">‚úÖ</div>
        <div class="b-nav-item" onclick="openModal('interviewModal')">üé§</div>
        <div class="b-nav-item" onclick="location.href='settings.html'">‚öôÔ∏è</div>
    </div>

    <div class="fab-container">
        <button class="fab-btn fab-draw" onclick="openModal('roughSheetModal')" title="Rough Sheet">‚úèÔ∏è</button>
        <button class="fab-btn fab-ai" onclick="openModal('aiChatModal')" title="Ask AI">ü§ñ</button>
    </div>

    <div id="aiChatModal" class="premium-modal" style="width: 360px; height: 500px;">
        <div style="background:linear-gradient(135deg,#6366f1,#a855f7); padding:20px 24px; color:white; display:flex; justify-content:space-between; align-items:center; border-radius:var(--radius-xl) var(--radius-xl) 0 0;">
            <div style="display:flex; align-items:center; gap:12px;">
                <span style="font-size:24px;">ü§ñ</span>
                <h3 style="margin:0; font-size:18px; font-weight:700;">Saraswati AI</h3>
            </div>
            <button onclick="closeAllModals()" style="background:rgba(255,255,255,0.2); border:none; color:white; font-size:16px; cursor:pointer; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center;">‚úï</button>
        </div>
        <div id="aiMessages" style="flex:1; padding:20px; overflow-y:auto; font-size:14px; display:flex; flex-direction:column; gap:16px; background:var(--ss-bg);"></div>
        <div style="padding:16px 20px; display:flex; gap:12px; background:var(--ss-surface); border-top:1px solid var(--ss-border); border-radius:0 0 var(--radius-xl) var(--radius-xl);">
            <input type="text" id="aiInput" placeholder="Ask your doubt..." style="flex:1;">
            <button onclick="askAI()" class="btn-ss" style="background:#6366f1; padding:12px 20px;">Send</button>
        </div>
    </div>

    <div id="soundMixerModal" class="premium-modal" style="width:340px; padding:32px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:28px;">
            <h3 style="margin:0; font-size:20px; font-weight:800; color:var(--ss-text);">üéß Soundscapes</h3>
            <button onclick="closeAllModals()" style="background:var(--ss-bg); border:none; font-size:16px; cursor:pointer; color:var(--ss-text-light); width:32px; height:32px; border-radius:50%;">‚úï</button>
        </div>
        <audio id="audioRain" loop src="https://assets.mixkit.co/active_storage/sfx/2491/2491.wav"></audio>
        <audio id="audioCafe" loop src="https://assets.mixkit.co/active_storage/sfx/364/364.wav"></audio>
        <audio id="audioLofi" loop src="https://assets.mixkit.co/active_storage/sfx/134/134.wav"></audio>
        
        <div style="display:flex; flex-direction:column; gap:24px;">
            <div style="display:flex; align-items:center; justify-content:space-between;"><span style="font-weight:600; font-size:15px;">üåßÔ∏è Rain</span><input type="range" min="0" max="100" value="0" oninput="adjustVolume('audioRain', this.value)" style="width:60%; accent-color:#3b82f6;"></div>
            <div style="display:flex; align-items:center; justify-content:space-between;"><span style="font-weight:600; font-size:15px;">‚òï Cafe</span><input type="range" min="0" max="100" value="0" oninput="adjustVolume('audioCafe', this.value)" style="width:60%; accent-color:#f59e0b;"></div>
            <div style="display:flex; align-items:center; justify-content:space-between;"><span style="font-weight:600; font-size:15px;">üéπ Lofi</span><input type="range" min="0" max="100" value="0" oninput="adjustVolume('audioLofi', this.value)" style="width:60%; accent-color:#8b5cf6;"></div>
        </div>
        <div style="text-align:center; margin-top:32px; font-size:13px; color:var(--ss-text-light); font-weight:500;">Mix sounds to create your perfect zone!</div>
    </div>

    <div id="vocabModal" class="premium-modal" style="width:400px; padding:32px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <h3 style="margin:0; color:var(--ss-primary); font-size:20px; font-weight:800;">üìÖ Daily IT Prep</h3>
            <button onclick="closeAllModals()" style="background:var(--ss-bg); border:none; font-size:16px; cursor:pointer; color:var(--ss-text-light); width:32px; height:32px; border-radius:50%;">‚úï</button>
        </div>
        <div style="background:rgba(239,68,68,0.05); border-left:4px solid #ef4444; padding:16px; margin-bottom:24px; border-radius:12px;">
            <b style="font-size:12px; color:#ef4444; letter-spacing:1px; text-transform:uppercase;">Today's Target</b>
            <div id="dailyTaskText" style="font-size:15px; font-weight:600; margin-top:8px; color:var(--ss-text);">Loading target...</div>
        </div>
        <b style="font-size:13px; color:var(--ss-text-light); letter-spacing:1px;">üìö 5 WORDS FOR TODAY</b>
        <div id="vocabList" style="margin-top:16px; height:280px; overflow-y:auto; padding-right:8px; display:flex; flex-direction:column; gap:12px;">
            <div style="text-align:center; color:grey; font-size:14px; padding:20px;">Fetching vocabulary...</div>
        </div>
    </div>

    <div id="interviewModal" class="premium-modal" style="width:450px; height:550px;">
        <div style="background: linear-gradient(135deg, #c026d3, #9333ea); padding: 24px; color: white; display: flex; justify-content: space-between; align-items: center; border-radius:var(--radius-xl) var(--radius-xl) 0 0;">
            <h3 style="margin:0; font-size:20px; font-weight:800;">üé§ AI Mock Interview</h3>
            <button onclick="closeAllModals()" style="background:rgba(255,255,255,0.2); border:none; color:white; font-size:16px; cursor:pointer; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center;">‚úï</button>
        </div>
        <div id="interviewChat" style="flex:1; padding:24px; overflow-y:auto; background:var(--ss-bg); font-size:14px; display:flex; flex-direction:column; gap:16px;">
            <div style="text-align:center; color:var(--ss-text-light); margin-top:30px; font-size:15px;"><b>Select a Topic to Start üëá</b></div>
            <div style="display:flex; gap:12px; justify-content:center; margin-top:16px; flex-wrap:wrap;">
                <button onclick="startMock('C++ Programming')" class="btn-ss" style="background:#3b82f6;">C++ Round</button>
                <button onclick="startMock('Data Structures (DSA)')" class="btn-ss" style="background:#f59e0b;">DSA Round</button>
                <button onclick="startMock('HR & Behavioral')" class="btn-ss" style="background:#10b981;">HR Round</button>
            </div>
        </div>
        <div style="padding:20px; background:var(--ss-surface); border-top:1px solid var(--ss-border); display:flex; gap:12px; border-radius:0 0 var(--radius-xl) var(--radius-xl);">
            <input type="text" id="interviewInput" placeholder="Type your answer..." style="flex:1;">
            <button onclick="sendInterviewMsg()" class="btn-ss" style="background:#c026d3; padding:12px 24px;">Send</button>
        </div>
    </div>

    <div id="bountyModal" class="premium-modal" style="width:500px; height:600px;">
        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 24px; color: white; display: flex; justify-content: space-between; align-items: center; border-radius:var(--radius-xl) var(--radius-xl) 0 0;">
            <h3 style="margin:0; font-size:20px; font-weight:800;">üí∞ Doubt Bounty Board</h3>
            <button onclick="closeAllModals()" style="background:rgba(255,255,255,0.2); border:none; color:white; font-size:16px; cursor:pointer; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center;">‚úï</button>
        </div>
        <div style="padding:24px; background:#fefce8; border-bottom:1px solid #fef08a;">
            <b style="font-size:13px; color:#b45309; letter-spacing:1px;">POST A DOUBT & OFFER POINTS</b>
            <div style="display:flex; gap:12px; margin-top:12px;">
                <input type="text" id="bountyQuestion" placeholder="e.g. Logic for reversing string?" style="flex:1; border-color:#fde047; background:white;">
                <input type="number" id="bountyPoints" placeholder="Pts" style="width:80px; border-color:#fde047; background:white;">
                <button onclick="postBounty()" class="btn-ss" style="background:#d97706;">Post</button>
            </div>
        </div>
        <div id="bountyList" style="flex:1; padding:24px; overflow-y:auto; background:var(--ss-bg); display:flex; flex-direction:column; gap:16px;"></div>
    </div>

    <div id="graphModal" class="premium-modal" style="width:450px; padding:32px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:28px;">
            <h3 style="margin:0; color:#10b981; display:flex; align-items:center; gap:12px; font-size:20px; font-weight:800;">
                <svg height="28" viewBox="0 0 16 16" version="1.1" width="28" fill="#10b981"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
                Consistency Heatmap
            </h3>
            <button onclick="closeAllModals()" style="background:var(--ss-bg); border:none; font-size:16px; cursor:pointer; color:var(--ss-text-light); width:32px; height:32px; border-radius:50%;">‚úï</button>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom: 24px; background:var(--ss-bg); padding:24px; border-radius:20px; border:1px solid var(--ss-border);">
            <div style="text-align:center; flex:1; border-right:1px solid var(--ss-border);">
                <b style="color:var(--ss-text-light); font-size:13px; letter-spacing:1px;">CURRENT STREAK</b><br>
                <span style="font-size:36px; font-weight:800; color:#f59e0b; display:inline-block; margin-top:8px;" id="currentStreak">0</span><span style="font-size:20px;">üî•</span>
            </div>
            <div style="text-align:center; flex:1;">
                <b style="color:var(--ss-text-light); font-size:13px; letter-spacing:1px;">TOTAL DAYS</b><br>
                <span style="font-size:36px; font-weight:800; color:var(--ss-primary); display:inline-block; margin-top:8px;" id="totalDays">0</span><span style="font-size:20px;">üìö</span>
            </div>
        </div>
        <div id="githubGraph" style="display:grid; grid-template-columns:repeat(10, 1fr); gap:6px; margin-top:16px;"></div>
    </div>

    <div id="flashcardModal" class="premium-modal" style="width:400px; padding:32px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <h3 style="margin:0; color:var(--ss-primary); font-size:20px; font-weight:800;">üÉè Smart Flashcards</h3>
            <button onclick="closeAllModals()" style="background:var(--ss-bg); border:none; font-size:16px; cursor:pointer; color:var(--ss-text-light); width:32px; height:32px; border-radius:50%;">‚úï</button>
        </div>
        <div style="background:var(--ss-bg); padding:20px; border-radius:16px; border:1px solid var(--ss-border); display:flex; flex-direction:column; gap:12px;">
            <input type="text" id="fcWord" placeholder="Front (e.g. Concept)" style="background:var(--ss-surface);">
            <input type="text" id="fcMeaning" placeholder="Back (Meaning)" style="background:var(--ss-surface);">
            <button onclick="addFlashcard()" class="btn-ss" style="padding:12px;">+ Create Card</button>
        </div>
        <div class="fc-container" id="fcContainer" onclick="flipFlashcard()">
            <div class="fc-inner">
                <div class="fc-front" id="fcFrontText">Click 'Create Card' to start</div>
                <div class="fc-back" id="fcBackText">Meaning will appear here</div>
            </div>
        </div>
        <div style="text-align:center; margin-top:24px; font-size:13px; color:var(--ss-text-light);">(Click card to flip)</div>
        <div style="display:flex; justify-content:space-between; margin-top:24px;">
            <button onclick="prevFlashcard()" class="btn-ss" style="background:var(--ss-bg); color:var(--ss-text); border:1px solid var(--ss-border); box-shadow:none;">‚ùÆ Prev</button>
            <span id="fcCounter" style="font-size:15px; font-weight:700; color:var(--ss-text-light); align-self:center;">0 / 0</span>
            <button onclick="nextFlashcard()" class="btn-ss">Next ‚ùØ</button>
        </div>
        <button onclick="deleteCurrentCard()" style="width:100%; margin-top:20px; background:rgba(239,68,68,0.1); border:1px dashed rgba(239,68,68,0.4); color:#ef4444; padding:12px; border-radius:12px; cursor:pointer; font-weight:700; transition:0.2s;">üóëÔ∏è Delete this Card</button>
    </div>

    <div id="roughSheetModal" class="premium-modal" style="width:85vw; height:85vh; max-width:1200px;">
        <div style="padding:20px 32px; background:var(--ss-surface); display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid var(--ss-border); border-radius:var(--radius-xl) var(--radius-xl) 0 0;">
            <b style="font-size:18px; font-weight:800;">‚úèÔ∏è Digital Rough Work</b>
            <div style="display:flex; gap:12px;">
                <button onclick="saveRoughWork()" class="btn-ss" style="background:#10b981;">üíæ Save PNG</button>
                <button onclick="clearCanvas()" class="btn-ss" style="background:rgba(239,68,68,0.1); color:#ef4444; border:1px solid rgba(239,68,68,0.2); box-shadow:none;">Clear</button> 
                <button onclick="closeAllModals()" class="btn-ss" style="background:var(--ss-bg); color:var(--ss-text); border:1px solid var(--ss-border); box-shadow:none;">Close</button>
            </div>
        </div>
        <canvas id="drawingCanvas" style="width:100%; height:calc(100% - 80px); cursor:crosshair; background:white; border-radius:0 0 var(--radius-xl) var(--radius-xl);"></canvas>
    </div>

    <script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>
    
    <script>
        const API = ""; // Empty for relative path deployment
        let activeChatId = null, myTasks = [], timerInterval, timeLeft = 1500, isFocusMode = true, player, isPlaying = false, countdownInterval;
        let drawing = false; const canvas = document.getElementById('drawingCanvas'); const ctx = canvas.getContext('2d');
        let currentUser = null; 

        // --- INIT & CORE ---
        async function initDashboard() {
            const token = localStorage.getItem('token');
            if(!token) return window.location.href="login.html";
            if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

            try {
                const res = await fetch(`${API}/profile`, { headers:{ 'x-auth-token': token } });
                const user = await res.json();
                if(res.ok) {
                    currentUser = user; 
                    document.getElementById('progressFill').style.width = Math.min((user.studyPoints/150)*100, 100) + "%";
                    if(user.profilePic) document.getElementById('myProfilePic').src = user.profilePic;
                    
                    loadLB(); loadTasks(); loadNotes(); renderCalendar(user.attendance || []); 
                    loadExamData(user);
                    updateOnlineDisplay();
                    setInterval(updateOnlineDisplay, 15000);

                    // AUTO-JOIN LOGIC
                    const urlParams = new URLSearchParams(window.location.search);
                    const inviteRoom = urlParams.get('roomID');
                    if(inviteRoom) { setTimeout(() => joinRoom(inviteRoom), 800); }
                }
            } catch (err) { console.error("Init Error:", err); }
        }

        // --- NEW MODAL CONTROLLER ---
        function openModal(modalId) {
            document.getElementById('modalOverlay').style.display = 'block';
            setTimeout(() => { document.getElementById('modalOverlay').style.opacity = '1'; }, 10);
            const m = document.getElementById(modalId);
            m.classList.add('show');
            if(modalId === 'roughSheetModal') {
                setTimeout(() => { canvas.width = m.clientWidth; canvas.height = m.clientHeight - 80; ctx.lineWidth=3; ctx.lineCap="round"; ctx.strokeStyle='#4f46e5'; }, 300);
            } else if(modalId === 'graphModal') { renderGitHubGraph(); }
            else if(modalId === 'bountyModal') { loadBounties(); }
            else if(modalId === 'flashcardModal') { renderFlashcard(); }
        }

        function closeAllModals() {
            document.getElementById('modalOverlay').style.opacity = '0';
            setTimeout(() => { document.getElementById('modalOverlay').style.display = 'none'; }, 300);
            document.querySelectorAll('.premium-modal').forEach(m => m.classList.remove('show'));
            if(document.getElementById('fcContainer')) document.getElementById('fcContainer').classList.remove('flipped');
        }

        // Bridge functions for HTML buttons
        function toggleAI() { openModal('aiChatModal'); }
        function toggleSoundMixer() { openModal('soundMixerModal'); }
        function toggleInterviewMode() { openModal('interviewModal'); }
        function toggleBountyModal() { openModal('bountyModal'); }
        function toggleGraphModal() { openModal('graphModal'); }
        function toggleFlashcardModal() { openModal('flashcardModal'); }
        function toggleRoughSheet() { openModal('roughSheetModal'); }

        // --- REST OF THE LOGIC STAYS THE SAME ---
        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); }
        async function updateOnlineDisplay() { try { const res = await fetch(`${API}/online-count`); const data = await res.json(); document.getElementById('onlineCount').innerText = data.count; } catch(e){} }
        
        function uploadPic() {
            const file = document.getElementById('fileInput').files[0];
            if(!file || file.size > 50000) return alert("File too big! (Max 50KB)");
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = async function() {
                document.getElementById('myProfilePic').src = reader.result;
                await fetch(`${API}/upload-pic`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'x-auth-token': localStorage.getItem('token') }, body: JSON.stringify({ image: reader.result }) });
            };
        }

        function downloadPDF() {
            const element = document.getElementById('studyNotes');
            const div = document.createElement('div');
            div.innerHTML = `<h2 style="color:#4f46e5; font-family:sans-serif;">StudyStream Notes</h2><hr><p style="font-family:sans-serif; line-height:1.6;">${element.value.replace(/\n/g, '<br>')}</p>`;
            html2pdf().from(div).save('StudyStream_Notes.pdf');
        }

        function joinRoom(roomName) {
            const userName = currentUser ? currentUser.username : "Student_" + Math.floor(Math.random() * 1000);
            const userId = currentUser ? currentUser._id : "ID_" + Math.floor(Math.random() * 10000);
            startZegoVideo(roomName, userName, userId);
        }
        function joinCustom() { const roomName = document.getElementById('customRoomInput').value.trim(); if (!roomName) return alert("Enter Code!"); joinRoom(roomName); }
        function startZegoVideo(roomID, userName, userID) {
            const container = document.getElementById('video-container'); container.innerHTML = ''; 
            const appID = 702436637; const serverSecret = "c9859aad8afd20feff7681d4624bd67d"; 
            const kitToken = ZegoUIKitPrebuilt.generateKitTokenForTest(appID, serverSecret, roomID, userID, userName);
            const zp = ZegoUIKitPrebuilt.create(kitToken);
            zp.joinRoom({ container: container, scenario: { mode: ZegoUIKitPrebuilt.VideoConference }, showScreenSharingButton: true, showUserList: true, layout: "Grid", sharedLinks: [{ name: 'Join Link', url: window.location.origin + window.location.pathname + '?roomID=' + roomID }], onLeaveRoom: () => { window.location.reload(); } });
        }

        function loadExamData(user) { if (user.examDate && user.examName) startCountdown(user.examName, user.examDate); else { document.getElementById('examSetup').style.display = 'block'; document.getElementById('examDisplay').style.display = 'none'; } }
        async function saveExamDate() { const name = document.getElementById('targetName').value, date = document.getElementById('targetDate').value; if(!name || !date) return alert("Fill details!"); await fetch(`${API}/update-exam`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'x-auth-token': localStorage.getItem('token') }, body: JSON.stringify({ examName: name, examDate: date }) }); startCountdown(name, date); }
        function startCountdown(name, dateStr) { document.getElementById('examSetup').style.display = 'none'; document.getElementById('examDisplay').style.display = 'block'; document.getElementById('displayExamName').innerText = name.toUpperCase(); const target = new Date(dateStr).getTime(); if (countdownInterval) clearInterval(countdownInterval); countdownInterval = setInterval(() => { const now = new Date().getTime(), dist = target - now; if (dist < 0) { clearInterval(countdownInterval); document.getElementById('daysLeft').innerText = "00"; return; } document.getElementById('daysLeft').innerText = Math.floor(dist / (1000 * 60 * 60 * 24)).toString().padStart(2, '0'); document.getElementById('hoursLeft').innerText = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0'); }, 1000); }
        function editExam() { document.getElementById('examSetup').style.display = 'block'; document.getElementById('examDisplay').style.display = 'none'; }
        
        async function loadTasks(){ const res=await fetch(`${API}/tasks`,{headers:{'x-auth-token':localStorage.getItem('token')}}); myTasks=await res.json(); renderTasks(); }
        function renderTasks(){ document.getElementById('taskList').innerHTML=myTasks.map((t,i)=>`<div style="padding:14px 16px; background:var(--ss-bg); border-radius:12px; border:1px solid var(--ss-border); display:flex; justify-content:space-between; align-items:center; font-size:14px; font-weight:500;">${t} <span onclick="deleteTask(${i})" style="color:#ef4444; cursor:pointer; background:rgba(239,68,68,0.1); padding:4px 8px; border-radius:8px; transition:0.2s;" onmouseover="this.style.background='rgba(239,68,68,0.2)'" onmouseout="this.style.background='rgba(239,68,68,0.1)'">‚úï</span></div>`).join(''); }
        async function addTask(){ const v=document.getElementById('taskInput').value; if(v){myTasks.push(v); document.getElementById('taskInput').value=""; await fetch(`${API}/tasks`,{method:'POST',headers:{'Content-Type':'application/json','x-auth-token':localStorage.getItem('token')},body:JSON.stringify({tasks:myTasks})}); renderTasks();} }
        async function deleteTask(i){myTasks.splice(i,1); renderTasks(); await fetch(`${API}/tasks`,{method:'POST',headers:{'Content-Type':'application/json','x-auth-token':localStorage.getItem('token')},body:JSON.stringify({tasks:myTasks})});}

        async function loadNotes(){ const res=await fetch(`${API}/notes`,{headers:{'x-auth-token':localStorage.getItem('token')}}); const d=await res.json(); document.getElementById('studyNotes').value=d.notes||""; }
        document.getElementById('studyNotes').addEventListener('input', _.debounce(async()=>{ document.getElementById('saveStatus').style.display='inline-block'; await fetch(`${API}/notes`,{method:'POST',headers:{'Content-Type':'application/json','x-auth-token':localStorage.getItem('token')},body:JSON.stringify({notes:document.getElementById('studyNotes').value})}); setTimeout(() => { document.getElementById('saveStatus').style.display='none'; }, 2000); },1000));

        function renderCalendar(d){ const g=document.getElementById('calendarGrid'), t=new Date(new Date().getFullYear(), new Date().getMonth()+1, 0).getDate(); let h=''; for(let i=1;i<=t;i++){ const date=new Date(new Date().getFullYear(), new Date().getMonth(), i).toDateString(); h+=`<div class="cal-day" style="background:${d.includes(date)?'#10b981':'var(--ss-bg)'}; color:${d.includes(date)?'white':'var(--ss-text-light)'}; border:1px solid var(--ss-border);">${i}</div>`; } g.innerHTML=h; }
        async function loadLB(){ const s=document.getElementById('stateFilter').value; const res=await fetch(`${API}/leaderboard${s!=="All"?'?state='+s:''}`); const d=await res.json(); document.getElementById('leaderboard').innerHTML=d.map((u,i)=>`<div style="padding:14px 16px; background:var(--ss-bg); border-radius:12px; border:1px solid var(--ss-border); font-size:14px; display:flex; justify-content:space-between; align-items:center;"><b><span style="color:var(--ss-text-light); margin-right:8px;">#${i+1}</span> ${u.username}</b> <span style="background:rgba(245,158,11,0.1); color:#d97706; padding:4px 10px; border-radius:12px; font-weight:800;">‚≠ê ${u.studyPoints}</span></div>`).join(''); }

        function clearCanvas(){ctx.clearRect(0,0,canvas.width,canvas.height);}
        function saveRoughWork() { const image = canvas.toDataURL("image/png"); const link = document.createElement('a'); link.download = 'StudyStream_RoughWork.png'; link.href = image; link.click(); }
        canvas.addEventListener('mousedown',(e)=>{drawing=true; ctx.beginPath(); ctx.moveTo(e.offsetX,e.offsetY);});
        canvas.addEventListener('mousemove',(e)=>{if(drawing){ctx.lineTo(e.offsetX,e.offsetY); ctx.stroke();}});
        canvas.addEventListener('mouseup',()=>drawing=false);
        
        var tag=document.createElement('script'); tag.src="https://www.youtube.com/iframe_api"; document.getElementsByTagName('script')[0].parentNode.insertBefore(tag, document.getElementsByTagName('script')[0]);
        function onYouTubeIframeAPIReady() { player=new YT.Player('youtube-player',{height:'0',width:'0',videoId:'jfKfPfyJRdk',playerVars:{'playsinline':1,'controls':0}}); }
        function toggleMusic() { if(isPlaying){player.pauseVideo(); document.getElementById('playBtn').innerText="‚ñ∂"; document.getElementById('playBtn').style.color="#0f172a"; isPlaying=false;}else{player.playVideo(); document.getElementById('playBtn').innerText="‚è∏"; document.getElementById('playBtn').style.color="#4f46e5"; isPlaying=true;} }
        function setVolume(v){if(player)player.setVolume(v);}

        async function askAI(){ const i=document.getElementById('aiInput'), t=i.value; if(t){ addAiMsg(t,'user'); i.value=''; const l=addAiMsg('Thinking...','ai'); const res=await fetch(`${API}/ask-ai`,{method:'POST',headers:{'Content-Type':'application/json','x-auth-token':localStorage.getItem('token')},body:JSON.stringify({prompt:t})}); const d=await res.json(); document.getElementById(l).innerText=d.text.replace(/\*/g, ''); document.getElementById('aiMessages').scrollTop = document.getElementById('aiMessages').scrollHeight; } }
        function addAiMsg(t,s){ const d=document.createElement('div'), id=Math.random().toString(36); d.id=id; d.style.background=s==='user'?'linear-gradient(135deg,#6366f1,#8b5cf6)':'white'; d.style.color=s==='user'?'white':'#1e293b'; d.style.padding='12px 16px'; d.style.borderRadius='16px'; d.style.alignSelf=s==='user'?'flex-end':'flex-start'; d.style.maxWidth='85%'; d.style.lineHeight='1.5'; d.style.boxShadow='var(--shadow-sm)'; d.style.border=s==='user'?'none':'1px solid var(--ss-border)'; d.innerText=t; document.getElementById('aiMessages').appendChild(d); document.getElementById('aiMessages').scrollTop = document.getElementById('aiMessages').scrollHeight; return id; }

        function adjustVolume(audioId, volumeValue) { const audio = document.getElementById(audioId); const volume = volumeValue / 100; if (volume > 0 && audio.paused) audio.play(); else if (volume === 0 && !audio.paused) audio.pause(); audio.volume = volume; }
        async function openDailyVocab() { openModal('vocabModal'); try { const res = await fetch(`${API}/daily-vocab`, { headers: { 'x-auth-token': localStorage.getItem('token') } }); const data = await res.json(); document.getElementById('dailyTaskText').innerText = data.task; document.getElementById('vocabList').innerHTML = data.vocab.map(v => `<div style="background:var(--ss-bg); padding:16px; border-radius:16px; border:1px solid var(--ss-border);"><div style="font-weight:800; color:var(--ss-text); font-size:16px;">${v.word}</div><div style="font-size:14px; color:var(--ss-text-light); margin:8px 0;"><b>Hindi:</b> ${v.meaning}</div><div style="font-size:12px; color:#10b981; font-weight:600;">Syn: <span style="font-weight:400; color:var(--ss-text-light);">${v.synonym}</span> | <span style="color:#ef4444;">Ant:</span> <span style="font-weight:400; color:var(--ss-text-light);">${v.antonym}</span></div></div>`).join(''); } catch(err) { document.getElementById('vocabList').innerHTML = `<div style="color:red; font-size:13px; text-align:center;">Connection failed.</div>`; } }
        
        function toggleStrictMode() { strictMode = !strictMode; const btn = document.getElementById('strictModeBtn'); if (strictMode) { btn.style.background = 'rgba(239, 68, 68, 0.1)'; btn.style.color = '#ef4444'; if (document.documentElement.requestFullscreen) { document.documentElement.requestFullscreen().then(() => { setTimeout(() => { alert("üö® STRICT FOCUS MODE ON!\n\nWebsite Full Screen mode mein aa gayi hai. Get to work!"); }, 500); }).catch(e => { alert("üö® STRICT MODE ON!"); }); } } else { btn.style.background = 'rgba(100, 116, 139, 0.1)'; btn.style.color = '#64748b'; if (document.fullscreenElement) document.exitFullscreen().catch(e => console.log(e)); } }
        function updateDisplay() { const m = Math.floor(timeLeft/60).toString().padStart(2,'0'), s=(timeLeft%60).toString().padStart(2,'0'); document.getElementById('timerDisplay').innerText=`${m}:${s}`; document.title=`${m}:${s} - Focus`; }
        function startPomodoro() { clearInterval(timerInterval); isFocusMode=true; timeLeft=25*60; document.getElementById('timerStatus').innerText="Deep Work Mode"; document.getElementById('timerStatus').style.background="rgba(79, 70, 229, 0.1)"; document.getElementById('timerStatus').style.color="var(--ss-primary)"; runTimer(); }
        function startBreak() { clearInterval(timerInterval); isFocusMode=false; timeLeft=5*60; document.getElementById('timerStatus').innerText="Chai Break"; document.getElementById('timerStatus').style.background="rgba(16, 185, 129, 0.1)"; document.getElementById('timerStatus').style.color="#10b981"; runTimer(); }
        function runTimer() { updateDisplay(); timerInterval=setInterval(()=>{timeLeft--; updateDisplay(); if(timeLeft<=0){clearInterval(timerInterval); alert("Time Up! Check your next schedule.");}},1000); }
        function resetTimer() { clearInterval(timerInterval); timeLeft=25*60; updateDisplay(); }

        function startMock(topic) { interviewTopic = topic; document.getElementById('interviewChat').innerHTML = `<div style="text-align:center; color:var(--ss-text-light); font-size:13px; margin-bottom:20px; font-weight:600;">üöÄ Starting <b style="color:var(--ss-primary);">${topic}</b> Interview...</div>`; fetchInterviewAI(`Act as a strict IT technical interviewer for ${topic} at TCS/Infosys. Ask the first question. Wait for my answer. Very short responses.`); }
        async function sendInterviewMsg() { const inp = document.getElementById('interviewInput'); const text = inp.value.trim(); if (!text) return; addInterviewBubble(text, 'user'); inp.value = ''; fetchInterviewAI(`I am giving a mock interview for ${interviewTopic}. My answer: "${text}". Evaluate strictly. Right or wrong? Ask next question.`); }
        function addInterviewBubble(text, sender) { const div = document.createElement('div'); div.style.padding = '12px 18px'; div.style.borderRadius = '16px'; div.style.maxWidth = '85%'; div.style.lineHeight = '1.5'; if (sender === 'user') { div.style.background = 'linear-gradient(135deg, #c026d3, #9333ea)'; div.style.color = 'white'; div.style.alignSelf = 'flex-end'; div.style.borderBottomRightRadius = '4px'; } else { div.style.background = 'white'; div.style.color = '#1e293b'; div.style.border = '1px solid var(--ss-border)'; div.style.alignSelf = 'flex-start'; div.style.borderBottomLeftRadius = '4px'; div.style.boxShadow = 'var(--shadow-sm)'; } div.innerText = text; document.getElementById('interviewChat').appendChild(div); document.getElementById('interviewChat').scrollTop = document.getElementById('interviewChat').scrollHeight; return div; }
        async function fetchInterviewAI(promptStr) { const loadingDiv = addInterviewBubble('Thinking...', 'ai'); try { const res = await fetch(`${API}/ask-ai`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'x-auth-token': localStorage.getItem('token') }, body: JSON.stringify({ prompt: promptStr }) }); const data = await res.json(); loadingDiv.innerText = data.text.replace(/\*/g, ''); document.getElementById('interviewChat').scrollTop = document.getElementById('interviewChat').scrollHeight; } catch(e) { loadingDiv.innerText = "Connection lost!"; } }

        async function loadBounties() { const listDiv = document.getElementById('bountyList'); listDiv.innerHTML = '<div style="text-align:center; color:grey; font-size:13px;">Fetching queries...</div>'; try { const res = await fetch(`${API}/bounties`); const bounties = await res.json(); if (bounties.length === 0) { listDiv.innerHTML = '<div style="text-align:center; color:grey; font-size:14px; margin-top:20px;">No open bounties! Be the first.</div>'; return; } listDiv.innerHTML = bounties.map(b => `<div style="background:white; border:1px solid var(--ss-border); border-radius:16px; padding:20px; box-shadow:var(--shadow-sm);"><div style="display:flex; justify-content:space-between; margin-bottom:12px;"><span style="font-size:13px; color:var(--ss-text-light);">Asked by <b style="color:var(--ss-text);">@${b.asker}</b></span><span style="background:rgba(245,158,11,0.1); color:#d97706; padding:4px 12px; border-radius:12px; font-size:12px; font-weight:800;">üí∞ ${b.bountyPoints} Pts</span></div><div style="font-size:16px; font-weight:700; color:var(--ss-text); margin-bottom:16px; line-height:1.4;">${b.question}</div><button onclick="alert('Solve feature backend needed!')" class="btn-ss" style="background:rgba(245,158,11,0.05); color:#d97706; width:100%; border:2px dashed rgba(245,158,11,0.4); box-shadow:none;">Solve & Claim Reward</button></div>`).join(''); } catch(e) { listDiv.innerHTML = '<div style="color:red; font-size:13px;">Connection error!</div>'; } }
        async function postBounty() { const question = document.getElementById('bountyQuestion').value, points = document.getElementById('bountyPoints').value; if(!question || !points) return alert("Fill all details!"); try { const res = await fetch(`${API}/bounties`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'x-auth-token': localStorage.getItem('token') }, body: JSON.stringify({ question, points }) }); const data = await res.json(); if(data.error) alert(data.error); else { document.getElementById('bountyQuestion').value = ''; document.getElementById('bountyPoints').value = ''; loadBounties(); document.getElementById('progressFill').style.width = Math.min((data.remainingPoints/150)*100, 100) + "%"; } } catch(e) { alert("Error!"); } }

        function renderGitHubGraph() { if(!currentUser) return; const att = currentUser.attendance || []; document.getElementById('totalDays').innerText = att.length; document.getElementById('currentStreak').innerText = calculateStreak(att); const graphDiv = document.getElementById('githubGraph'); let boxesHTML = ''; for(let i = 49; i >= 0; i--) { const d = new Date(); d.setDate(d.getDate() - i); const dateStr = d.toDateString(); let boxColor = 'var(--ss-bg)'; let border = '1px solid var(--ss-border)'; if(att.includes(dateStr)) { const colors = ['#a7f3d0', '#34d399', '#10b981', '#059669']; boxColor = colors[(i === 0) ? 3 : Math.floor(Math.random() * 3) + 1]; border = 'none'; } boxesHTML += `<div title="${dateStr}" style="width:100%; aspect-ratio:1; background:${boxColor}; border:${border}; border-radius:6px; transition:0.2s; cursor:pointer;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'"></div>`; } graphDiv.innerHTML = boxesHTML; }
        
        function handleSmartSearch(event) { const query = event.target.value.toLowerCase().trim(); const tasks = document.getElementById('taskList').children; for(let i = 0; i < tasks.length; i++) { const taskText = tasks[i].innerText.toLowerCase(); tasks[i].style.display = taskText.includes(query) ? 'flex' : 'none'; } const lbItems = document.getElementById('leaderboard').children; for(let i = 0; i < lbItems.length; i++) { const lbText = lbItems[i].innerText.toLowerCase(); lbItems[i].style.display = lbText.includes(query) ? 'flex' : 'none'; } if (event.key === 'Enter' && query !== '') { openModal('aiChatModal'); document.getElementById('aiInput').value = event.target.value; askAI(); event.target.value = ''; for(let i = 0; i < tasks.length; i++) tasks[i].style.display = 'flex'; for(let i = 0; i < lbItems.length; i++) lbItems[i].style.display = 'flex'; } }

        function renderFlashcard() { if (flashcards.length === 0) { document.getElementById('fcFrontText').innerText = "Empty Deck!"; document.getElementById('fcBackText').innerText = "Add below."; document.getElementById('fcCounter').innerText = "0 / 0"; return; } document.getElementById('fcContainer').classList.remove('flipped'); setTimeout(() => { document.getElementById('fcFrontText').innerText = flashcards[currentFcIndex].front; document.getElementById('fcBackText').innerText = flashcards[currentFcIndex].back; document.getElementById('fcCounter').innerText = `${currentFcIndex + 1} / ${flashcards.length}`; }, 150); }
        function flipFlashcard() { if(flashcards.length > 0) document.getElementById('fcContainer').classList.toggle('flipped'); }
        function nextFlashcard() { if (flashcards.length === 0) return; currentFcIndex = (currentFcIndex + 1) % flashcards.length; renderFlashcard(); }
        function prevFlashcard() { if (flashcards.length === 0) return; currentFcIndex = (currentFcIndex - 1 + flashcards.length) % flashcards.length; renderFlashcard(); }
        function addFlashcard() { const front = document.getElementById('fcWord').value, back = document.getElementById('fcMeaning').value; if(!front || !back) return alert("Fill both sides!"); flashcards.push({ front, back }); localStorage.setItem('ss_flashcards', JSON.stringify(flashcards)); document.getElementById('fcWord').value = ''; document.getElementById('fcMeaning').value = ''; currentFcIndex = flashcards.length - 1; renderFlashcard(); }
        function deleteCurrentCard() { if(flashcards.length === 0) return; flashcards.splice(currentFcIndex, 1); localStorage.setItem('ss_flashcards', JSON.stringify(flashcards)); currentFcIndex = 0; renderFlashcard(); }
    </script>
</body>
</html>